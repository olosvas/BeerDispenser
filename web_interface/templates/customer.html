{% extends 'layout.html' %}

{% block title %}Order Beer{% endblock %}

{% block head %}
<style>
    .beer-option {
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 2px solid transparent;
    }
    
    .beer-option:hover {
        transform: translateY(-5px);
    }
    
    .beer-option.selected {
        border-color: var(--bs-primary);
        background-color: rgba(255, 165, 0, 0.1);
    }
    
    .progress-container {
        max-width: 600px;
        margin: 0 auto;
    }
    
    .order-steps .step {
        position: relative;
        padding-bottom: 30px;
    }
    
    .order-steps .step:not(:last-child):after {
        content: '';
        position: absolute;
        left: 12px;
        top: 30px;
        height: calc(100% - 30px);
        width: 2px;
        background-color: var(--bs-gray-600);
    }
    
    .order-steps .step.completed:not(:last-child):after {
        background-color: var(--bs-success);
    }
    
    .order-steps .step-icon {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        background-color: var(--bs-gray-600);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
    }
    
    .order-steps .step.active .step-icon {
        background-color: var(--bs-primary);
    }
    
    .order-steps .step.completed .step-icon {
        background-color: var(--bs-success);
    }
    
    .age-verification {
        max-width: 500px;
        margin: 0 auto;
    }
    
    .beer-ready-message {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    #beer-animation {
        max-width: 200px;
        margin: 20px auto;
    }
    
    .glass {
        position: relative;
        height: 250px;
        width: 80px;
        background-color: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: none;
        border-radius: 0 0 15px 15px;
        margin: 0 auto;
        overflow: hidden;
    }
    
    .beer {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 0%;
        background-color: var(--beer-amber);
        transition: height 1s ease-in-out;
    }
    
    .foam {
        position: absolute;
        bottom: 100%;
        left: 0;
        width: 100%;
        height: 20px;
        background-color: var(--beer-foam);
        border-radius: 50% 50% 0 0;
        transition: bottom 1s ease-in-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Step 1: Beer Selection -->
    <div id="beer-selection" class="card shadow-sm mb-4">
        <div class="card-header bg-dark">
            <h2 class="text-center mb-0"><i class="fas fa-beer me-2"></i> Order Your Beer</h2>
        </div>
        <div class="card-body">
            <div class="text-center mb-4">
                <p class="lead">Select your preferred size:</p>
            </div>
            
            <div class="row justify-content-center g-4">
                <div class="col-md-5">
                    <div class="card beer-option h-100" data-size="300">
                        <div class="card-body text-center">
                            <i class="fas fa-beer fa-3x mb-3 text-warning"></i>
                            <h3>Small Beer</h3>
                            <p class="mb-1">300ml</p>
                            <p class="text-muted">Perfect for a quick refreshment</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-5">
                    <div class="card beer-option h-100" data-size="500">
                        <div class="card-body text-center">
                            <i class="fas fa-beer fa-4x mb-3 text-warning"></i>
                            <h3>Large Beer</h3>
                            <p class="mb-1">500ml</p>
                            <p class="text-muted">The ultimate thirst quencher</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="d-grid gap-2 col-md-6 mx-auto mt-4">
                <button id="continue-btn" class="btn btn-primary btn-lg" disabled>
                    <i class="fas fa-check-circle me-2"></i> Continue
                </button>
            </div>
        </div>
    </div>
    
    <!-- Step 2: Age Verification -->
    <div id="age-verification" class="card shadow-sm mb-4 d-none">
        <div class="card-header bg-dark">
            <h2 class="text-center mb-0"><i class="fas fa-id-card me-2"></i> Age Verification</h2>
        </div>
        <div class="card-body">
            <div class="age-verification">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    By law, we must verify that you are of legal drinking age before dispensing alcoholic beverages.
                </div>
                
                <form id="verification-form" class="mt-4">
                    <div class="mb-3">
                        <label for="fullname" class="form-label">Full Name (as shown on ID)</label>
                        <input type="text" class="form-control" id="fullname" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="birthdate" class="form-label">Date of Birth</label>
                        <input type="date" class="form-control" id="birthdate" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id-number" class="form-label">ID Number</label>
                        <input type="text" class="form-control" id="id-number" required>
                    </div>
                    
                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="age-confirmation" required>
                        <label class="form-check-label" for="age-confirmation">
                            I confirm that I am of legal drinking age and the information provided is accurate.
                        </label>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-check-circle me-2"></i> Verify & Order
                        </button>
                        <button type="button" id="back-to-selection" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i> Back
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Step 3: Processing Order -->
    <div id="processing-order" class="card shadow-sm mb-4 d-none">
        <div class="card-header bg-dark">
            <h2 class="text-center mb-0"><i class="fas fa-cog fa-spin me-2"></i> Preparing Your Beer</h2>
        </div>
        <div class="card-body">
            <div class="progress-container">
                <div id="beer-animation" class="mb-4">
                    <div class="glass">
                        <div class="beer"></div>
                        <div class="foam"></div>
                    </div>
                </div>
                
                <div class="progress mb-4" style="height: 25px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                </div>
                
                <div class="order-steps">
                    <div id="step-1" class="step d-flex align-items-start mb-3">
                        <div class="step-icon">
                            <i class="fas fa-check text-light"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">Order Received</h5>
                            <p class="text-muted mb-0">Your order has been received and is being processed.</p>
                        </div>
                    </div>
                    
                    <div id="step-2" class="step d-flex align-items-start mb-3">
                        <div class="step-icon">
                            <i class="fas fa-glass-whiskey text-light"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">Dispensing Cup</h5>
                            <p class="text-muted mb-0">A cup is being positioned under the tap.</p>
                        </div>
                    </div>
                    
                    <div id="step-3" class="step d-flex align-items-start mb-3">
                        <div class="step-icon">
                            <i class="fas fa-beer text-light"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">Pouring Beer</h5>
                            <p class="text-muted mb-0">Your beer is being poured with the perfect amount of foam.</p>
                        </div>
                    </div>
                    
                    <div id="step-4" class="step d-flex align-items-start">
                        <div class="step-icon">
                            <i class="fas fa-check-double text-light"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">Ready for Pickup</h5>
                            <p class="text-muted mb-0">Your beer is ready! Please take it from the delivery tray.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Step 4: Beer Ready -->
    <div id="beer-ready" class="card shadow-sm mb-4 d-none">
        <div class="card-header bg-success">
            <h2 class="text-center mb-0"><i class="fas fa-check-circle me-2"></i> Your Beer is Ready!</h2>
        </div>
        <div class="card-body text-center">
            <div class="beer-ready-message mb-4">
                <i class="fas fa-beer fa-5x mb-3 text-warning"></i>
                <h3>Enjoy Your Beer!</h3>
                <p class="lead">Your <span id="beer-size-display"></span> beer has been dispensed and is waiting for you.</p>
                <p>Please collect your beer from the delivery tray.</p>
            </div>
            
            <div class="d-grid gap-2 col-md-6 mx-auto mt-4">
                <button id="new-order-btn" class="btn btn-primary btn-lg">
                    <i class="fas fa-plus-circle me-2"></i> Place Another Order
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Variables
    let selectedSize = null;
    let orderProgress = 0;
    let currentStep = 1;
    
    // DOM Elements
    const beerOptions = document.querySelectorAll('.beer-option');
    const continueBtn = document.getElementById('continue-btn');
    const beerSelection = document.getElementById('beer-selection');
    const ageVerification = document.getElementById('age-verification');
    const processingOrder = document.getElementById('processing-order');
    const beerReady = document.getElementById('beer-ready');
    const verificationForm = document.getElementById('verification-form');
    const backToSelectionBtn = document.getElementById('back-to-selection');
    const progressBar = document.getElementById('progress-bar');
    const beerSizeDisplay = document.getElementById('beer-size-display');
    const newOrderBtn = document.getElementById('new-order-btn');
    const beer = document.querySelector('.beer');
    const foam = document.querySelector('.foam');
    
    // Step 1: Beer Selection
    beerOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Remove selected class from all options
            beerOptions.forEach(opt => opt.classList.remove('selected'));
            
            // Add selected class to clicked option
            this.classList.add('selected');
            
            // Enable continue button
            continueBtn.disabled = false;
            
            // Store selected size
            selectedSize = this.dataset.size;
        });
    });
    
    // Continue to age verification
    continueBtn.addEventListener('click', function() {
        beerSelection.classList.add('d-none');
        ageVerification.classList.remove('d-none');
    });
    
    // Back to selection
    backToSelectionBtn.addEventListener('click', function() {
        ageVerification.classList.add('d-none');
        beerSelection.classList.remove('d-none');
    });
    
    // Age verification form submission
    verificationForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get form data
        const fullname = document.getElementById('fullname').value;
        const birthdate = document.getElementById('birthdate').value;
        const idNumber = document.getElementById('id-number').value;
        
        // Disable form during verification
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Verifying...';
        submitBtn.disabled = true;
        
        // Send verification request to server
        fetch('/api/verify_age', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                fullname: fullname,
                birthdate: birthdate,
                id_number: idNumber
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && data.verified) {
                // Verification successful
                // Start the beer dispensing process
                ageVerification.classList.add('d-none');
                processingOrder.classList.remove('d-none');
                
                // Set beer size display
                beerSizeDisplay.textContent = selectedSize + 'ml';
                
                // Start dispensing
                startDispensing();
            } else {
                // Verification failed
                alert(data.message || 'Age verification failed. Please try again.');
                
                // Re-enable form
                submitBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i> Verify & Order';
                submitBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error during verification:', error);
            alert('An error occurred during verification. Please try again.');
            
            // Re-enable form
            submitBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i> Verify & Order';
            submitBtn.disabled = false;
        });
    });
    
    // Start a new order
    newOrderBtn.addEventListener('click', function() {
        // Reset form
        verificationForm.reset();
        
        // Reset beer selection
        beerOptions.forEach(opt => opt.classList.remove('selected'));
        continueBtn.disabled = true;
        
        // Reset progress
        orderProgress = 0;
        currentStep = 1;
        progressBar.style.width = '0%';
        document.querySelectorAll('.step').forEach(step => {
            step.classList.remove('active', 'completed');
        });
        document.getElementById('step-1').classList.remove('active');
        
        // Reset beer animation
        beer.style.height = '0%';
        foam.style.bottom = '100%';
        
        // Show beer selection
        beerReady.classList.add('d-none');
        beerSelection.classList.remove('d-none');
    });
    
    // Function to handle the dispensing process
    function startDispensing() {
        // Set the first step as active
        document.getElementById('step-1').classList.add('active', 'completed');
        updateProgress(10);
        
        // Simulate dispensing cup (step 2)
        setTimeout(() => {
            document.getElementById('step-2').classList.add('active');
            updateProgress(25);
            
            // Send request to dispense cup
            fetch('/api/dispense', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ volume: parseInt(selectedSize) })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Dispensing started:', data);
                
                // Start checking status periodically
                const statusCheck = setInterval(() => {
                    fetch('/api/state')
                        .then(response => response.json())
                        .then(stateData => {
                            updateBasedOnState(stateData.state, statusCheck);
                        })
                        .catch(error => {
                            console.error('Error checking state:', error);
                        });
                }, 1000);
            })
            .catch(error => {
                console.error('Error starting dispensing:', error);
                alert('There was an error processing your order. Please try again.');
                // Reset to beer selection
                processingOrder.classList.add('d-none');
                beerSelection.classList.remove('d-none');
            });
        }, 1500);
    }
    
    // Update progress based on system state
    function updateBasedOnState(state, statusCheck) {
        switch(state) {
            case 'dispensing_cup':
                if (currentStep < 2) {
                    document.getElementById('step-1').classList.add('completed');
                    document.getElementById('step-2').classList.add('active');
                    updateProgress(25);
                    currentStep = 2;
                }
                break;
                
            case 'pouring_beer':
                if (currentStep < 3) {
                    document.getElementById('step-2').classList.add('completed');
                    document.getElementById('step-3').classList.add('active');
                    updateProgress(50);
                    currentStep = 3;
                    
                    // Start beer animation
                    animateBeerPouring();
                }
                break;
                
            case 'delivering_cup':
                if (currentStep < 4) {
                    document.getElementById('step-3').classList.add('completed');
                    document.getElementById('step-4').classList.add('active');
                    updateProgress(85);
                    currentStep = 4;
                }
                break;
                
            case 'idle':
                // If we were in a previous step, this means the process completed
                if (currentStep > 1) {
                    document.getElementById('step-4').classList.add('completed');
                    updateProgress(100);
                    
                    // Stop checking status
                    clearInterval(statusCheck);
                    
                    // Wait a moment and then show the ready screen
                    setTimeout(() => {
                        processingOrder.classList.add('d-none');
                        beerReady.classList.remove('d-none');
                    }, 1500);
                }
                break;
                
            case 'error':
                clearInterval(statusCheck);
                alert('There was an error processing your order. Please try again.');
                // Reset to beer selection
                processingOrder.classList.add('d-none');
                beerSelection.classList.remove('d-none');
                break;
        }
    }
    
    // Update progress bar
    function updateProgress(percentage) {
        orderProgress = percentage;
        progressBar.style.width = orderProgress + '%';
        progressBar.setAttribute('aria-valuenow', orderProgress);
    }
    
    // Animate beer pouring
    function animateBeerPouring() {
        // Calculate fill height based on selected size
        const fillPercentage = selectedSize === '300' ? 70 : 90;
        
        // Animate beer filling
        setTimeout(() => {
            beer.style.height = fillPercentage + '%';
            foam.style.bottom = fillPercentage + '%';
        }, 500);
    }
</script>
{% endblock %}